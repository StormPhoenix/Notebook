---
id: pt6j4jlvumei3xzob2u98de
title: Dedicated Server
desc: ''
updated: 1689246927863
created: 1689158325296
tags:
    - unrealengine
---

#todolist

教程 ：https://www.cnblogs.com/timy/p/10201818.html

https://github.com/dawnarc/ue4_fps_game/tree/master

https://km.woa.com/articles/show/520809?kmref=search&from_page=1&no=8

https://docs.unrealengine.com/5.2/zh-CN/multiplayer-programming-quick-start-for-unreal-engine/

----

# Article (1)
https://docs.unrealengine.com/5.2/zh-CN/networking-overview-for-unreal-engine/

** Key Points **

- 游戏运行实际发生在服务器上，而不在客户端
- 客户端负责提供游戏输入；服务器负责**复制**游戏运行状态到客户端

因此，在设计层面上需要：
- 仔细划分需要复制的信息类别(游戏交互、美术效果，私人玩家信息)，不同类型的信息与不同机组相关联
- 最小化必要信息复制量，减少带宽

** 网络模式分类 ** ： 分布式与 CS 模式

考虑两个因素：带宽 & 延时
分布式模式：监听服务器(listen server)，每个机器要接收其他机器的消息，带宽高；
专属服务器：专属服务器(dedicated server)，服务器处理所有消息，带宽高，客户端只和服务端通信，带宽低

在有服务器控制的模式下：
- Actor 控制权：客户端的 Actor 需要区分 “由本地控制”、“由服务器控制” 两个属性。
- 减少复制量：
  - 客户端的 Actor 需要区分是否要复制到服务器(不在玩家身边、距离过远被裁剪)，以减少通信量。
  - 客户端的 Actor 需要区分优先级，当带宽不够时，优先复制哪个 Actor

RPC 相关 
#todolist 没看懂类型
- RPC 类型 ：Server\Client\NetMulticast 
- 可靠性 ： 能不能保证该 RPC 一定能执行成功(通过多次调用实现来保证成功)

## Unreal Engine 中的 Dedicated Server 与客户端的特点
- 客户端和服务器的代码写在一起，依据当前机器是 Server 还是 Client 来选择执行 #todolist 补充示例
- 游戏状态共享机制：游戏状态存储在服务器，部分游戏状态存储只与特定客户端共享、部分游戏状态是服务器和多个客户端共享

** 客户端和服务器的代码写在一起，那么哪些代码是 Server 执行？哪些代码是 Client 执行？**
### UE 任意对象的控制权
控制权如何定义
- Role: 描述机器本地对象由谁控制，有三种取值 ROLE_AutonomousProxy、ROLE_SimulatedProxy、ROLE_Authority
- RemoteRole: 描述机器本地对象对应的远程对象由谁控制，取值同上

UE 中对象由谁控制？
- ROLE_Authority : 完全由 Server 控制
- ROLE_SimulatedProxy : 
- ROLE_AutonomousProxy

### UE 任意对象的所有者 Owner

链接：

## Unreal Engine 对象同步机制
几个问题要解决：

Q1. 要同步哪些属性。远程需要控制的；不能是依据被删除的；依据对象自身设置的同步条件

Q2. 多久同步一次。设置同步间隔 NetUpadteTime。

Q3. 先同步哪个对象？再同步哪个对象。按照优先级配置，可节约带宽；对象距离我多近？对象在不在视锥之内的后同步？

Q4. 怎么同步对象？把对象状态保存起来存到 buffer，Tick 时比较对象和 buffer 中的状态是否一致，如果不一致则放到 list 里发送出去。

## RPC 调用
类型：
- Server Call Client
- Client Call Server(Run on Server): 客户端调用，服务器执行
- Server Multi-cast

## 对象同步和 RPC 调用的机制
- 可靠机制
- 丢包重传

# NetProfiler

流量检测软件

## 关注点
- 短时间流量激增，某些数据不会去复制了，客户端长时间不会收到属性同步
- 数组同步，当数组长度发生改变，UE 会尝试同步所有数组元素，所以最好使用定长数组
- 精心确定对象同步时机。对象的同步不需要很频繁；可设置同步时机；对象同步频率也可以调低下；
- 精心确定对象同步范围。UStruct 不是所有属性需要同步；

# QA 
- UE 没有办法保证属性同步顺序强依赖。
- 可复制对象 & 专属链接 有什么关系

----
# Article (2)

https://www.cnblogs.com/timy/p/10201818.html

高性能网络库：ACE，libuv，RakNet

----

# Article (3)

#todolist
[[proxy.unrealengine.Tutorial#networking-in-basic---simple-replication-example]]

## 属性的同步

属性添加 `ReplicatedUsing` 宏，当属性同步后被修改，触发回调函数 `OnFuncationCall` 执行(由 `ReplicatedUsing` 修饰的回调函数仅在客户端执行)
```c++
UPROPERTY(ReplicatedUsing = OnFuncationCall)
float Property;

UFUNCTION()
void OnFuncationCall();
```

如果要在蓝图里设置 `ReplicatedUsing`，对应的选项是 `RepNotify`。

## 设置 RPC 函数 

向服务器发起 RPC
```c++
UFUNCTION(Server, Reliable, WithValidation)
void RpcFunc();

// 判断：是否要执行 RpcFunc()
bool RpcFunc_Validate();

// RpcFunc 函数具体实现
void RpcFunc_Implementation();
```

#todolist 为什么不能直接实现 RpcFunc() ? 猜测因为 UE 要自动做反射

项目参考：https://github.com/dawnarc/ue4_fps_game/tree/master

----

# Article (4)
#todolist
https://www.cnblogs.com/timy/p/10201818.html
分别编译打包 Client、Server 版本

# Article (5)

#todolist
https://docs.unrealengine.com/5.2/zh-CN/networking-and-multiplayer-in-unreal-engine/

