---
id: qoifni239nr9qowj0mwy4vt
title: Vertex Factory
desc: ''
updated: 1689137105765
created: 1689067138535
tags:
  - unrealengine
---

作用：
- 绑定 Shader 
- 绑定顶点数据 VertexBuffer 
- 其他需要绑定数据

前文配置顶点数据已知的操作：
- 创建 FVertexDeclarationRHI
- FVertexDeclarationRHI 设置到 graphics pipeline 

#todolist 复习 FVertexDeclaration 具体写法

参考： [[VertexFactory 相关类概述 | proxy.unrealengine.renderpipeline#vertexfactory-class-overview]]

封装之后相关类：
- FVertexStreamComponent: 封装顶点数据：VertexBuffer, StreamOffset, Offset, Stride 
- FStaticMeshDataType: 封装不同类型的顶点数据(Position, Color, TangentBasis)，用 FVertexStreamComponent 封装.

> FVertexFactory 持有 FStaticMeshDataType 及其子类变量，用于存储顶点数据。如果是自定义 FVertexFactory 类型，甚至可以不用 UE 定义的 FStaticMeshDataType，只要自己定义一些 FVertexStreamComponent、FRHIShaderResourceView 就行了。

- FVertexElement: 描述 FVertexStreamComponent 和着色器的哪个 VertexBuffer 输入对应起来(StreamIndex, AttributeIndex)；然后据此创建 FRHIVertexDecleration
- FRHIVertexDecleration: 描述顶点数据输入布局 input layout：VertexBuffer 对应着色器的第几个输入、VertexBuffer 内部数据类型、Offset、Stride 

> FVertexFactory::InitDeclaration()，输入 FVertexElement 数组，创建 FRHIVertexDecleration



#todolist FRHIVertexDecleration 会被缓存起来，被 VertexFactory 复用，这是什么意思？

## Vertex Buffer & Vertex Declaration
FVertexStreamComponent: 定义顶点格式，GPU 侧需要这个来确定如何读取顶点数据。
FRHIShaderResourceView: 保存实际的顶点数据。

以上由 FLocalVertexFactory::FDataType (或者其子类) 封装。

## Mesh 与 Vertex Buffer
示例：RenderData->VertexBuffer

https://zhuanlan.zhihu.com/p/128656015

IMPLEMENT_VERTEX_FACTORY_TYPE

FVertexStream <.. FVertexBuffer

FPrimitiveSceneProxy  
    <.. UMaterialInterface
    <.. FXXXVertexFactory

### 宏绑定
FVertexFactory 里的顶点数据输入和 HLSL 绑定：IMPLEMENT_VERTEX_FACTORY_TYPE
    绑定 LocalVertexFactory.usf，该 usf 是 UberShader，真正运行时的顶点输入需要靠宏开关定义。宏开关由 FVertexFactory 

IMPLEMENT_MATERIAL_SHADER_TYPE 绑定的是 C++ Shader 和 HLSL 中的参数
IMPLEMENT_VERTEX_FACTORY_TYPE 绑定的是 C++ VertexFactory 和 HLSL 中的顶点数据

VertexFactory主要负责将特定网格类型的顶点从CPU传递到GPU，然后在VertexShader中使用，它描述了UE的各个渲染Pass输入给Shader的顶点数据都是什么

这篇文章讲了 VertexFactory 涉及到的几个核心类：FRHIResource、FRenderResource，SRV & UAV

FRenderResource - 创建|释放 -> FRHIResource

https://zhuanlan.zhihu.com/p/361322348

#todolist DECLARE_VERTEX_FACTORY_TYPE(FLocalVertexFactory) 有什么作用